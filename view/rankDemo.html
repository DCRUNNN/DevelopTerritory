<!DOCTYPE html>
<html lang="zh-CN">
 <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
    <title>开疆拓土-排行榜</title>
    <link rel="shortcut icon" type="image/x-icon" href="images/logo.png" media="screen" />
    <!-- Bootstrap core CSS -->
    <link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS-->
     <link href="stylesheets/common.css" rel="stylesheet" />
     <link href="stylesheets/rank.css" rel="stylesheet" />
  </head>

</head>

<body>
     <nav id = "nav" class="navbar-default navbar-inverse" role="navigation">
        <div class="navbar-header">
            <div class = "title">
                <img class = "logo" src = "images/w_logo.png">
                <img class = "w_logo" src = "images/title.png">
            </div>
            <button type="button" class="navbar-toggle nav-content navbar-right" data-toggle="collapse" data-target="#navbar-collapse">
                <span class="sr-only">切换导航</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
        </div>
        <div class="collapse navbar-collapse nav-content" id="navbar-collapse">
		    <ul class = "nav navbar-nav">
		      <li><a href = "#"><img src = "images/map.png">地图</a></li>
		      <li><a href = "#"><img src = "images/user.png">个人主页</a></li>
		      <li><a href = "#"><img src = "images/deal.png">交易所</a></li>
		      <li class = "choosen"><a href = "#"><img src = "images/medal.png">排行榜</a></li>
		      <li><a href = "#"><img src = "images/infor.png">说明</a></li>
		    </ul>
		    <ul class = "nav navbar-nav navbar-right">
		      <li><a href = "#"><img src = "images/money.png">钱包插件</a></li>
		    </ul>
        </div>
    </nav>

    <div class = "container">
    	<div class = "raw">
	    	<div class = "col-xs-offset-1 col-sm-5 col-xs-10">
		    	<a class="btn btn-pic" id="cityBuilding" onclick="getBuildingRank(1)">
		            <img src = "images/resources/城市.png">
		            <p>- 查看城市排行榜 -</p>
		        </a>
		    </div>
		    <div class = "col-xs-offset-1 col-sm-offset-0 col-sm-5 col-xs-10">
		        <a class="btn btn-pic" id="villageBuilding" onclick="getBuildingRank(0)">
		            <img src = "images/resources/村庄.png">
		            <p>- 查看村庄排行榜 -</p>
		        </a>
		    </div>
		</div>

		<div class = "raw">
		    <div class = "col-xs-offset-1 col-sm-2 col-xs-5">
		        <a class="btn btn-pic" id="woodProduct" onclick="getProductRank(0)">
		            <img src = "images/resources/木头.png">
		            <p>- 木头排行榜 -</p>
		        </a>
		    </div>
		    <div class = "col-sm-2 col-xs-5">
		        <a class="btn btn-pic"  id="brickProduct" onclick="getProductRank(1)">
		            <img src = "images/resources/砖头.png">
		            <p>- 砖块排行榜 -</p>
		        </a>
		    </div>
		    <div class = "col-xs-offset-1 col-sm-offset-0 col-sm-2 col-xs-5">
		        <a class="btn btn-pic" id="woolProduct" onclick="getProductRank(2)">
		            <img src = "images/resources/羊毛.png">
		            <p>- 羊毛排行榜 -</p>
		        </a>
		    </div>
		    <div class = "col-sm-2 col-xs-5">
		        <a class="btn btn-pic" id="foodProduct" onclick="getProductRank(3)">
		            <img src = "images/resources/粮食.png">
		            <p>- 粮食排行榜 -</p>
		        </a>
		    </div>
		    <div class = "col-xs-offset-1 col-sm-offset-0 col-sm-2 col-xs-5">
		        <a class="btn btn-pic" id="mineralProduct" onclick="getProductRank(4)"">
		            <img src = "images/resources/矿石.png">
		            <p>- 矿石排行榜 -</p>
		        </a>
		    </div>
		</div>
    </div>

    <div class="modal fade" id="rank" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	    <div class="modal-dialog">
	        <div class="modal-content">
	            <div class="modal-header">
	                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	                <h4 class="modal-title" id="myModalLabel"><img src = "images/dark/medal.png">排行榜</h4>
	            </div>
	            <div class="modal-body">
	                <ul id="rank">

                    </ul>
	            </div>
	        </div><!-- /.modal-content -->
	    </div><!-- /.modal -->
	</div>

        <div>
            <ul id="rank">

            </ul>
        </div>

    <div class = "footer">
        <a href = "#">@Copyright 2018</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href = "#">联系我们</a> 
    </div>

</body>


<script src="../dist/js/jquery-3.3.1.min.js"></script>
<script src="../dist/js/jquery.fullPage.js"></script>
<script src="../dist/js/nebulas/nebPay.js"></script>
<script src="../dist/js/nebulas/nebulas.js"></script>

<script src="../resources/bootstrap/js/bootstrap.js"></script>


<script>
    function checkID() {
        window.postMessage({
            "target": "contentscript",
            "data": {},
            "method": "getAccount",
        }, "*");
        window.addEventListener('message', function (e) {
            if (e.data && e.data.data) {
                if (e.data.data.account) {//这就是当前钱包中的地址
                    var account = e.data.data.account;
                    if(account=='n1QVFUAEEE8Nz3TsCe2TtcW53ZVrR5Qb9af' || account=='n1Ft17PTSw7YjaQULBiKyBeMguZCcECqHek'){
                        window.location.href='createNovel.html';
                    }else{
                        alert("不好意思，只有管理员才可以新建小说，您可以去参与小说创作！");
                        return;
                    }
                }
            }
        });
    }
</script>

<script>

    "use strict";

    var dappContactAddress = "n1gWbChQ3qq6sLc1V6Cn5Vwy65RnB5nU8cp";
    var nebulas = require("nebulas"),
        Account = nebulas.Account,
        neb = new nebulas.Neb();
    neb.setRequest(new nebulas.HttpRequest("https://mainnet.nebulas.io"))

    // NebPay SDK 为不同平台的交易提供了统一的支付接口
    // 开发者在Dapp页面中使用NebPay API可以通过浏览器插件钱包、手机app钱包等实现交易支付和合约调用。
    var NebPay = require("nebpay");
    var nebPay = new NebPay();

    var building = ["村庄", "城市"];
    var product = ["木头", "砖块", "羊毛", "粮食", "矿石"];

    // 执行合约返回的交易流水号，用于查询交易信息
    var serialNumber;
    
    function compare(property){
        return function(a,b){
            return a[property] - b[property];
        }
    }

    function getBuildingRank(buildingID) {
    	$("#myModalLabel").html("<img src = 'images/dark/medal.png'>" + building[buildingID] + "排行榜");
    	$('#rank').modal('show');
        var to = dappContactAddress;
        var value = "0";
        var callFunction = "getBuilding";
        var callArgs = "[\"" + buildingID + "\"]";
        console.log(callArgs);

        serialNumber = nebPay.call(to, value, callFunction, callArgs, {    //使用nebpay的call接口去调用合约,
            listener: function (resp) {
                //console.log("thecallback is " + resp)
                console.log("The result is:"+ resp.result);
                var sortResult = resp.result;
                sortResult = sortResult.sort(compare('numOfBuilding'));
                var length = sortResult.length>100 ? 100 : sortResult.length;
                for(var i = 0;i<length;i++){
                    var ele = '<li>'+ sortResult[i].numOfBuilding + '</li>';
                    $('#rank').append(ele);
                }
            }
        });
    }

    function getProductRank(productID) {
    	$("#myModalLabel").html("<img src = 'images/dark/medal.png'>" + product[productID] + "排行榜");
    	$('#rank').modal('show');
        var to = dappContactAddress;
        var value = "0";
        var callFunction = "getProduct";
        var callArgs = "[\"" + productID + "\"]";
        console.log(callArgs);

        serialNumber = nebPay.call(to, value, callFunction, callArgs, {    //使用nebpay的call接口去调用合约,
            listener: function (resp) {
                console.log("thecallback is " + resp);
                var sortResult = resp.result;
                sortResult = sortResult.sort(compare('numOfProduct'));
                var length = sortResult.length>100 ? 100 : sortResult.length;
                for(var i = 0;i<length;i++){
                    var ele = '<li>'+ sortResult[i].numOfBuilding + '</li>';
                    $('#rank').append(ele);
                }
            }
        });
    }

</script>

<script src="../resources/vue/vue.js"></script>
<script src="../resources/vue-resource/vue-resource.js"></script>

<script src="../dist/js/pages/rankDemo.js"></script>



</html>